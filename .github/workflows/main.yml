name: "CI/CD: Windows Build Agent (V34 - CIM Boost)"

on:
  workflow_dispatch:

jobs:
  build-agent-deploy:
    name: "Deploying High-Perf Agent..."
    runs-on: windows-latest
    timeout-minutes: 360

    env:
      TS_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      PASS: ${{ secrets.RDP_PASSWORD }}
      DISCORD: ${{ secrets.DISCORD_WEBHOOK }}
      TOOL_URL: "https://www.dropbox.com/scl/fi/xqqk8u72nvgia7wpgswnc/Fortnite-V7.zip?rlkey=s6g9fgvitjnbz3sdjmbmou4ga&st=t5oyksu3&dl=1"
      LINK_A: "https://fn-sorter-pro.streamlit.app/"
      LINK_B: "https://miri1408x-create.github.io/txt-merger/"

    steps:
      - name: "‚öôÔ∏è Force 32GB RAM on D: (CIM Method)"
        shell: pwsh
        run: |
          $ErrorActionPreference = 'SilentlyContinue'
          Write-Host "üöÄ Starting Memory Expansion..."

          # 1. Disable Automatic PageFile Management
          $sys = Get-CimInstance Win32_ComputerSystem -EnableAllPrivileges
          if ($sys.AutomaticManagedPagefile) {
              $sys.AutomaticManagedPagefile = $false
              Set-CimInstance -CimInstance $sys
              Write-Host "‚úÖ Automatic Paging Disabled."
          }

          # 2. Check for D: Drive
          if (Test-Path "D:\") {
              Write-Host "‚úÖ D: Drive Detected."
              
              # 3. Nuke old PageFiles (C:)
              Get-CimInstance Win32_PageFileSetting | Remove-CimInstance
              
              # 4. Create MASSIVE 32GB PageFile on D: (Live Creation)
              try {
                  New-CimInstance -ClassName Win32_PageFileSetting -Property @{Name="D:\pagefile.sys"; InitialSize=32768; MaximumSize=32768} -ErrorAction Stop
                  Write-Host "‚úÖ SUCCESS: 32GB Virtual RAM Created on D:\"
                  echo "DL_PATH=D:\Downloads" >> $env:GITHUB_ENV
              } catch {
                  Write-Error "‚ùå Failed to create D: PageFile. Trying C: fallback..."
                  New-CimInstance -ClassName Win32_PageFileSetting -Property @{Name="C:\pagefile.sys"; InitialSize=12288; MaximumSize=12288}
                  echo "DL_PATH=C:\Users\RDP\Downloads" >> $env:GITHUB_ENV
              }
          } else {
              Write-Host "‚ö†Ô∏è No D: Drive. Using C: Boost."
              New-CimInstance -ClassName Win32_PageFileSetting -Property @{Name="C:\pagefile.sys"; InitialSize=12288; MaximumSize=12288}
              echo "DL_PATH=C:\Users\RDP\Downloads" >> $env:GITHUB_ENV
          }

          # 5. Verify Total Commit Limit (Live Check)
          $os = Get-CimInstance Win32_OperatingSystem
          $totalCommit = [math]::Round(($os.TotalVirtualMemorySize / 1024), 2)
          Write-Host "üìä TOTAL SYSTEM MEMORY (Committed): $totalCommit MB"

      - name: "üõ°Ô∏è Security Policy Override"
        shell: pwsh
        run: |
          $ErrorActionPreference = 'SilentlyContinue'
          
          # Disable Security Warnings
          $attach = "HKCU:\Software\Microsoft\Windows\CurrentVersion\Policies\Attachments"
          if (!(Test-Path $attach)) { New-Item -Path $attach -Force | Out-Null }
          Set-ItemProperty -Path $attach -Name "SaveZoneInformation" -Value 1 -Type DWord -Force
          
          $assoc = "HKCU:\Software\Microsoft\Windows\CurrentVersion\Policies\Associations"
          if (!(Test-Path $assoc)) { New-Item -Path $assoc -Force | Out-Null }
          Set-ItemProperty -Path $assoc -Name "LowRiskFileTypes" -Value ".exe;.bat;.cmd;.vbs;.zip;.rar;.rdp;.msi" -Force

          # Performance
          powercfg -setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
          Set-Service -Name "Audiosrv" -StartupType Automatic; Start-Service "Audiosrv"
          Stop-Service "wuauserv" -Force; Set-Service "wuauserv" -StartupType Disabled

          # User & RDP
          if (-not $env:PASS) { Write-Error "RDP_PASSWORD Secret Missing"; exit 1 }
          $secPass = ConvertTo-SecureString $env:PASS -AsPlainText -Force
          New-LocalUser -Name "RDP" -Password $secPass -Description "Build Agent" -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "RDP"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDP"
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

      - name: "üåê Connect Tailscale"
        shell: pwsh
        run: |
          if (-not $env:TS_KEY) { Write-Error "Missing TAILSCALE_AUTH_KEY"; exit 1 }
          
          # Chocolatey is reliable
          choco install tailscale -y --no-progress --skip-virus-check --limit-output
          
          # Unattended Connection
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey="$env:TS_KEY" --hostname="Agent-$env:GITHUB_RUN_ID" --unattended --accept-routes
          
          Start-Sleep -Seconds 10
          $ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
          echo "AGENT_IP=$ip" >> $env:GITHUB_ENV
          Write-Host "‚úÖ Network Active: $ip"

      - name: "üì• Provision Workspace"
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path $env:DL_PATH -Force | Out-Null
          
          # Download Tool
          Invoke-WebRequest "$env:TOOL_URL" -OutFile "$env:DL_PATH\Toolbox.zip" -UseBasicParsing
          Unblock-File "$env:DL_PATH\Toolbox.zip"
          Write-Host "‚úÖ Tools Installed to $env:DL_PATH"

      - name: "üöÄ Startup Automation"
        shell: pwsh
        run: |
          $bootPath = "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp\Boot.bat"
          $chrome = "C:\Program Files\Google\Chrome\Application\chrome.exe"
          
          $script = @"
          @echo off
          :: 1. Security Killer Loop
          start "" powershell -WindowStyle Hidden -Command "while(\$true) { Get-ChildItem '$env:DL_PATH\*' -Recurse | Unblock-File; Start-Sleep -Seconds 1 }"
          
          :: 2. Launch Workspace
          start "" "$chrome" "$env:LINK_A" "$env:LINK_B"
          explorer.exe "$env:DL_PATH"
          "@
          
          Set-Content -Path $bootPath -Value $script
          Write-Host "‚úÖ Automation Configured."

      - name: "üîî Status Notification"
        shell: pwsh
        run: |
          if ($env:DISCORD) {
            $msg = @{ content = "üü¢ **Agent V34 Online**`nüåê IP: `$env:AGENT_IP``nüíæ Storage: $env:DL_PATH`n‚ö° RAM: 32GB (Hardware Forced)" }
            try { Invoke-RestMethod -Uri $env:DISCORD -Method Post -Body ($msg | ConvertTo-Json) -ContentType 'application/json' } catch {}
          }

      - name: "üõë Keep-Alive"
        shell: pwsh
        run: |
          Write-Host "Agent Active..."
          while ($true) { Start-Sleep -Seconds 60 }
